<!DOCTYPE html><html lang="ja"><head><meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>POTRABASH - Original Art Edition</title><style>
/* ä¿®æ­£2ï¼šã‚¹ãƒ¯ã‚¤ãƒ—ã¨ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’å®Œå…¨ã«è¨±å¯ */
body{
    background:#0b6623 url('hosi.png') no-repeat center center; 
    background-size: cover; 
    color:white; 
    font-family:sans-serif; 
    margin:0; padding:0; 
    overflow: auto; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’è¨±å¯ */
    min-width: 1000px; /* ã‚²ãƒ¼ãƒ ç”»é¢ã®å¹…ã‚’ç¢ºä¿ */
    min-height: 800px;
    -webkit-overflow-scrolling: touch; /* iOSã§ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æ»‘ã‚‰ã‹ã« */
}

/* ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ã¯ç”»é¢ã„ã£ã±ã„ã«è¡¨ç¤º */
#titleScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; background: rgba(0,0,0,0.6); }
.title-logo { width: 600px; max-width: 90%; height: auto; margin-bottom: 20px; filter: drop-shadow(0 0 15px rgba(0,0,0,0.5)); }
#titleScreen .menu { background: rgba(0,0,0,0.8); padding: 30px; border-radius: 20px; border: 2px solid rgba(255,255,255,0.2); text-align: center; backdrop-filter: blur(5px); }

#ui{width:100%; text-align:center; padding:15px 0; background:rgba(0,0,0,0.7); position: sticky; top: 0; z-index: 100; display: none;}
#table{position:relative; width:1000px; height:700px; margin: 20px auto; display: none;}

/* ä¸­å¤®ãƒœãƒƒã‚¯ã‚¹ */
#center{position:absolute;top:55%;left:50%;transform:translate(-50%,-50%);width:160px;height:220px;background:rgba(6,68,32,0.9);border-radius:12px;text-align:center;padding:10px;z-index:5;box-shadow: 0 0 20px rgba(0,0,0,0.8);border: 2px solid #0a5a2a;}

.player{position:absolute;width:280px;padding:10px;border-radius:15px;z-index:20;transition: all 0.3s; background:rgba(0,0,0,0.5); backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.1);}
.player.human, .player.reveal-all { width: 360px; min-height: 200px; background:rgba(255,255,255,0.15); z-index: 50;}
.hand,.field{display:flex;justify-content:center;gap:6px;margin:6px 0}
.card{width:50px;height:75px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:20px;box-shadow: 2px 2px 5px rgba(0,0,0,0.5);background-size: 100% 100%; background-repeat: no-repeat; position: relative; color: white; text-shadow: 1px 1px 2px black;}

.human .hand .card { width: 80px; height: 120px; font-size: 36px; cursor: pointer; transition: transform 0.2s; }
.v-3{background-color:#8b0000;}.v-2{background-color:#c0392b;}.v1{background-color:#ecf0f1; color:black; text-shadow: none;}.v3{background-color:#5dade2;}.v4{background-color:#f4d03f; color:black; text-shadow: none;}.back{background-color:#1c2833; border:1px solid #34495e;}
.dead{filter: grayscale(100%) brightness(40%); border: 3px solid red !important;}
.dead::after{content:"Ã—";font-size:50px;position:absolute;color:#ff0000;font-weight:900;top:50%;left:50%;transform:translate(-50%,-50%);text-shadow:none;z-index:100;}
.selectable{outline:4px solid #fff;cursor:pointer;animation:pulse 0.8s infinite}
@keyframes pulse { 0%{transform:scale(1)} 50%{transform:scale(1.05)} 100%{transform:scale(1)} }

button { padding: 12px 24px; cursor: pointer; border-radius: 8px; border: none; background: #eee; font-weight: bold; color: #333; transition: 0.2s; }
.btn-large { font-size: 24px; padding: 15px 40px; background: #f1c40f; color: #000; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }

.score-container { display: flex; gap: 3px; justify-content: flex-start; flex-wrap: wrap; margin-top: 10px; }
.score-pile { position: relative; width: 50px; height: 75px; margin: 0 auto; border: 1px dashed rgba(255,255,255,0.2); }
.score-card-stacked { position: absolute; left: 0; top: 0; width: 100% !important; height: 100% !important; }
.flying-card { position: fixed; z-index: 9999; pointer-events: none; }
.fan-hand { position: relative; height: 100px; display: flex; justify-content: center; align-items: center; }
.fan-card { position: absolute !important; transition: all 0.3s; transform-origin: center 120%; }
</style></head><body>

<audio id="bgm" loop> <source src="https://www.dropbox.com/scl/fi/49sn3at2wqynqjrvbazhr/bgm.mp3?rlkey=vq7qobgw31mljqu9xbs6pdkul&st=x7cbq7kf&raw=1" type="audio/mpeg"></audio>

<div id="titleScreen"> 
    <img src="rogo.png" alt="POTRABASH" class="title-logo"> 
    <div class="menu"> 
        <p style="font-size: 18px; margin-bottom: 20px;">Nightmare Mode (Original Art)</p> 
        <div style="margin-bottom: 25px;"> 
            <button onclick="window.open('rule.pdf', '_blank')" style="background:#444; color:white; border:1px solid #777; width:200px; margin-bottom:10px;"> ğŸ“– ãƒ«ãƒ¼ãƒ«ã‚’èª­ã‚€ </button> <br> 
            <button onclick="window.open('rule_en.pdf', '_blank')" style="background:#224; color:white; border:1px solid #55a; width:200px;"> ğŸŒ English Rules </button> 
        </div> 
        <select id="playerCount" style="font-size: 20px; padding: 10px; margin-bottom: 30px;"> 
            <option value="3">3äºº</option> <option value="4" selected>4äºº</option> <option value="5">5äºº</option> 
        </select><br> 
        <button class="btn-large" onclick="initGame()">Game Start</button> 
    </div>
</div>

<div id="ui"> 
    <span id="infoLabel" style="font-weight: bold; margin-right: 20px;"></span> 
    <button onclick="backToTitle()">ã‚¿ã‚¤ãƒˆãƒ«ã¸æˆ»ã‚‹</button>
</div>

<div id="table"> 
    <div id="center"> 
        <div style="font-size:14px;margin-bottom:8px">ä¸­å¤®ç²å¾—ã‚«ãƒ¼ãƒ‰</div> 
        <div id="centerCard" class="card" style="margin:0 auto 15px auto; width:80px; height:120px;"></div> 
        <button id="passBtn" onclick="pass()">ãƒ‘ã‚¹ã—ã¦çµ‚äº†</button> 
    </div>
</div>

<script>
// ãƒ­ã‚¸ãƒƒã‚¯éƒ¨åˆ†ã¯å¤‰æ›´ãªã—
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playSwooshSound() {
    if (audioCtx.state === 'suspended') audioCtx.resume();
    const duration = 0.15;
    const bufferSize = audioCtx.sampleRate * duration;
    const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
    const data = buffer.getChannelData(0);
    for (let i = 0; i < bufferSize; i++) { data[i] = Math.random() * 2 - 1; }
    const noise = audioCtx.createBufferSource();
    noise.buffer = buffer;
    const filter = audioCtx.createBiquadFilter();
    filter.type = 'bandpass';
    filter.frequency.setValueAtTime(3000, audioCtx.currentTime);
    filter.frequency.exponentialRampToValueAtTime(1500, audioCtx.currentTime + duration);
    filter.Q.value = 1.0;
    const gainNode = audioCtx.createGain();
    gainNode.gain.setValueAtTime(0.15, audioCtx.currentTime);
    gainNode.gain.linearRampToValueAtTime(0, audioCtx.currentTime + duration);
    noise.connect(filter); filter.connect(gainNode); gainNode.connect(audioCtx.destination);
    noise.start(); noise.stop(audioCtx.currentTime + duration);
}

const personalities = [{name:"å¼·æ¬²"},{name:"æ…é‡"},{name:"åˆºå®¢"},{name:"å¤§å™¨"}];
let players=[], deck=[], playerCount=4, startIndex=0, turnIndex=0, lap=1, centerCard=null, phase="title", pickIndex=0, lastPlayOrder=[];

function initGame() {
    playerCount = parseInt(document.getElementById("playerCount").value);
    document.getElementById("titleScreen").style.display = "none";
    document.getElementById("ui").style.display = "block";
    document.getElementById("table").style.display = "block";
    const bgm = document.getElementById("bgm");
    bgm.volume = 0.3;
    bgm.play().catch(e => console.log("BGM error"));
    if (audioCtx.state === 'suspended') audioCtx.resume();
    startGame();
}

function backToTitle() { phase = "title"; document.getElementById("bgm").pause(); document.getElementById("titleScreen").style.display = "flex"; document.getElementById("ui").style.display = "none"; document.getElementById("table").style.display = "none"; }

function aiThink(p) {
    const trait = p.trait.name;
    const mySum = p.field.reduce((a,v)=>a+v.value, 0);
    const others = players.filter(o => o.id !== p.id);
    const maxOther = Math.max(...others.map(o => o.field.reduce((a,v)=>a+v.value, 0)));
    const getCount = (player, val) => player.score.filter(s => s.value === val).length % 3;
    if (lap > 1 && mySum > maxOther && mySum > 0) { if (lap === 3 || mySum >= 4) return {action: "pass"}; }
    if (lap > 2 && mySum === maxOther && mySum > 0) return {action: "pass"};
    const choices = p.hand.map((c, idx) => {
        let score = 0; const proj = mySum + c.value; const myScoreCount = getCount(p, c.value); const humScoreCount = getCount(players[0], c.value);
        if (c.value > 0 && myScoreCount === 1) score += 2500;
        if (humScoreCount === 2 && c.value > 0) score += 1800;
        if (myScoreCount === 2) { if (c.value > 0) score -= 4000; if (c.value < 0) score += 2000; }
        if (trait === "å¼·æ¬²") { if(c.value >= 3) score += 300; if(proj > maxOther) score += 600; }
        else if (trait === "æ…é‡") { if(proj < -3) score -= 1500; if(proj > 7) score -= 1000; }
        else if (trait === "å¤§å™¨") { if(c.value === 1 && lap < 3) score -= 5000; if(proj >= maxOther) score += 1000; }
        else if (trait === "åˆºå®¢") { others.forEach(o => { const oSum = o.field.reduce((a,v)=>a+v.value, 0); if (oSum === proj && proj > 0) score += 1500; }); }
        return {idx, score: score + Math.random() * 50};
    }).sort((a,b)=>b.score - a.score);
    return {action: "play", index: choices[0].idx};
}

function nextPick() {
    if (!players.some(p => p.field.length)) { startIndex = (pickIndex) % playerCount; if (deck.length === 0 && players[0].hand.length === 0) return endGame(); return nextRound(); }
    const p = players[pickIndex];
    let others = players.filter(o => o.id !== p.id && o.field.length);
    let targets = others.length > 0 ? others : [p];
    if (p.id === 0) { render(true, targets.map(t => t.id)); return; }
    let bestT = targets[0], bestCi = 0, bestScore = -999999;
    targets.forEach(t => {
        t.field.forEach((c, ci) => {
            let s = 0; const my