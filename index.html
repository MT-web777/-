<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>POTRABASH - Original Art Edition</title>
    <style>
        /* å…¨ä½“è¨­å®šï¼šã‚¹ãƒãƒ›ã®èª¤å‹•ä½œé˜²æ­¢ */
        body {
            background:#0b6623 url('hosi.png') no-repeat center center; 
            background-size: cover; 
            color:white; 
            font-family:sans-serif; 
            margin:0; 
            padding:0; 
            overflow:hidden;
            touch-action: none; /* ã‚¹ãƒ¯ã‚¤ãƒ—ã‚’ã‚²ãƒ¼ãƒ å°‚ç”¨ã«ã™ã‚‹ */
            -webkit-user-select: none;
            user-select: none;
        }

        #titleScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; background: rgba(0,0,0,0.4); }
        .title-logo { width: 600px; max-width: 90%; height: auto; margin-bottom: 20px; filter: drop-shadow(0 0 15px rgba(0,0,0,0.5)); }
        #titleScreen .menu { background: rgba(0,0,0,0.7); padding: 30px; border-radius: 20px; border: 2px solid rgba(255,255,255,0.2); text-align: center; backdrop-filter: blur(5px); }
        
        #ui{width:100%;text-align:center;padding:10px 0;background:rgba(0,0,0,0.6);position:relative;z-index:100; display: none;}
        #table{position:relative;width:1000px;height:700px;margin:auto; display: none;}
        
        /* ã‚¹ãƒãƒ›ç”¨ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ï¼šç”»é¢ã‚µã‚¤ã‚ºã«åˆã‚ã›ã¦æ‹¡å¤§ç¸®å° */
        @media (max-width: 1000px) {
            #table { transform: scale(0.8); transform-origin: top center; }
        }

        /* ä»¥å‰ã®å£Šã‚ŒãŸCSSã‚³ãƒ¼ãƒ‰ã‚’ä¿®æ­£ */
        #center{position:absolute;top:50%;left:42%;transform:translate(-50%,-50%);width:160px;height:220px;background:rgba(6,68,32,0.8);border-radius:12px;text-align:center;padding:10px;z-index:5;box-shadow: 0 0 20px rgba(0,0,0,0.8);border: 2px solid #0a5a2a;}
        .player{position:absolute;width:280px;padding:10px;border-radius:15px;z-index:20;transition: all 0.3s; background:rgba(0,0,0,0.4); backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.1);}
        .player.human, .player.reveal-all { width: 360px; min-height: 200px; background:rgba(255,255,255,0.15); z-index: 50;}
        .hand,.field{display:flex;justify-content:center;gap:6px;margin:6px 0}
        .card{width:50px;height:75px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:20px;box-shadow: 2px 2px 5px rgba(0,0,0,0.5);background-size: 100% 100%; background-repeat: no-repeat; position: relative; color: white; text-shadow: 1px 1px 2px black;}
        .human .hand .card { width: 80px; height: 120px; font-size: 36px; cursor: pointer; transition: transform 0.2s; }
        .v-3{background-color:#8b0000;}.v-2{background-color:#c0392b;}.v1{background-color:#ecf0f1; color:black; text-shadow: none;}.v3{background-color:#5dade2;}.v4{background-color:#f4d03f; color:black; text-shadow: none;}.back{background-color:#1c2833; border:1px solid #34495e;}
        .dead{filter: grayscale(100%) brightness(40%); border: 3px solid red !important;}.dead::after{content:"Ã—";font-size:50px;position:absolute;color:#ff0000;font-weight:900;top:50%;left:50%;transform:translate(-50%,-50%);text-shadow:none;z-index:100;}
        .selectable{outline:4px solid #fff;cursor:pointer;animation:pulse 0.8s infinite}
        @keyframes pulse { 0%{transform:scale(1)} 50%{transform:scale(1.05)} 100%{transform:scale(1)} }
        
        button { padding: 10px 20px; cursor: pointer; border-radius: 8px; border: none; background: #eee; font-weight: bold; color: #333; transition: 0.2s; }
        .btn-large { font-size: 24px; padding: 15px 40px; background: #f1c40f; color: #000; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .score-container { display: flex; gap: 3px; justify-content: flex-start; flex-wrap: wrap; margin-top: 10px; }
        .score-pile { position: relative; width: 50px; height: 75px; margin: 0 auto; border: 1px dashed rgba(255,255,255,0.2); }
        .score-card-stacked { position: absolute; left: 0; top: 0; width: 100% !important; height: 100% !important; }
        .flying-card { position: fixed; z-index: 9999; pointer-events: none; }

        /* æ¨ªå‘ãæ¨å¥¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
        #orientation-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); color: white; z-index: 9999;
            justify-content: center; align-items: center; text-align: center; font-size: 20px;
        }
        @media (orientation: portrait) { #orientation-overlay { display: flex; } }
    </style>
</head>
<body>

<div id="orientation-overlay">ç”»é¢ã‚’æ¨ªå‘ãã«ã—ã¦éŠã‚“ã§ã­ï¼</div>

<audio id="bgm" loop>
    <source src="https://www.dropbox.com/scl/fi/49sn3at2wqynqjrvbazhr/bgm.mp3?rlkey=vq7qobgw31mljqu9xbs6pdkul&st=x7cbq7kf&raw=1" type="audio/mpeg">
</audio>

<div id="titleScreen">
    <img src="rogo.png" alt="POTRABASH" class="title-logo">
    <div class="menu">
        <p style="font-size: 18px; margin-bottom: 20px;">Nightmare Mode (Original Art)</p>
        <div style="margin-bottom: 25px;">
            <button onclick="window.open('rule.pdf', '_blank')" style="background:#444; color:white; border:1px solid #777; width:200px; margin-bottom:10px;">ğŸ“– ãƒ«ãƒ¼ãƒ«ã‚’èª­ã‚€ (æ—¥æœ¬èª)</button><br>
            <button onclick="window.open('rule_en.pdf', '_blank')" style="background:#224; color:white; border:1px solid #55a; width:200px;">ğŸŒ English Rules (PDF)</button>
        </div>
        <select id="playerCount" style="font-size: 20px; padding: 5px; margin-bottom: 30px;">
            <option value="3">3äºº</option>
            <option value="4" selected>4äºº</option>
            <option value="5">5äºº</option>
        </select><br>
        <button class="btn-large" onclick="initGame()">Game Start</button>
    </div>
</div>

<div id="ui">
  <span id="infoLabel" style="font-weight: bold; margin-right: 20px;"></span>
  <button onclick="backToTitle()">ã‚¿ã‚¤ãƒˆãƒ«ã¸æˆ»ã‚‹</button>
</div>

<div id="table">
  <div id="center">
    <div style="font-size:14px;margin-bottom:8px">ä¸­å¤®ç²å¾—ã‚«ãƒ¼ãƒ‰</div>
    <div id="centerCard" class="card" style="margin:0 auto 15px auto; width:80px; height:120px;"></div>
    <button id="passBtn" onclick="pass()">ãƒ‘ã‚¹ã—ã¦çµ‚äº†</button>
  </div>
</div>

<script>
// éŸ³å£°é–¢é€£
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
const bgm = document.getElementById("bgm");

function initGame() {
    playerCount = parseInt(document.getElementById("playerCount").value);
    document.getElementById("titleScreen").style.display = "none";
    document.getElementById("ui").style.display = "block";
    document.getElementById("table").style.display = "block";
    
    // BGMã®éŸ³é‡ã‚’è¨­å®šã—ã¦å†ç”Ÿ
    bgm.volume = 0.3;
    bgm.play().catch(e => console.log("BGMå†ç”Ÿã«ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œãŒå¿…è¦ã§ã™"));
    if (audioCtx.state === 'suspended') audioCtx.resume();
    
    startGame();
}

// ä»¥å‰ã®å…¨ãƒ­ã‚¸ãƒƒã‚¯ã‚’ã“ã“ã«çµ±åˆã—ã¾ã—ãŸ
const personalities = [ { name: "å¼·æ¬²" }, { name: "æ…é‡" }, { name: "åˆºå®¢" }, { name: "å¤§å™¨" } ];
let players=[], deck=[], playerCount=4, startIndex=0, turnIndex=0, lap=1, centerCard=null, phase="title", pickIndex=0;
let lastPlayOrder = [];

function playSwooshSound() {
    if (audioCtx.state === 'suspended') audioCtx.resume();
    const duration = 0.15;
    const bufferSize = audioCtx.sampleRate * duration;
    const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
    const data = buffer.getChannelData(0);
    for (let i = 0; i < bufferSize; i++) { data[i] = Math.random() * 2 - 1; }
    const noise = audioCtx.createBufferSource();
    noise.buffer = buffer;
    const filter = audioCtx.createBiquadFilter();
    filter.type = 'bandpass';
    filter.frequency.setValueAtTime(3000, audioCtx.currentTime);
    const gainNode = audioCtx.createGain();
    gainNode.gain.setValueAtTime(0.05, audioCtx.currentTime);
    noise.connect(filter); filter.connect(gainNode); gainNode.connect(audioCtx.destination);
    noise.start(); noise.stop(audioCtx.currentTime + duration);
}

function startGame(){
    deck=makeDeck(); 
    if(playerCount===3) {
        let newDeck = [];
        [-3,-2,1,3,4].forEach(v => { let count=0; deck.forEach(c => { if(c.value === v && count < 10) { newDeck.push(c); count++; } }); });
        deck = newDeck.sort(()=>Math.random()-0.5);
    }
    players=[];
    let shuffledTraits = [...personalities].sort(() => Math.random() - 0.5);
    for(let i=0;i<playerCount;i++) {
        let trait = (i === 0) ? null : shuffledTraits[(i - 1) % shuffledTraits.length];
        players.push({ id:i, hand:[], field:[], score:[], total:0, trait: trait });
    }
    for(let i=0;i<3;i++) players.forEach(p=>p.hand.push(deck.pop()));
    startIndex=0;
    nextRound();
}

function makeDeck(){let d=[];[-3,-2,1,3,4].forEach(v=>{for(let i=0;i<12;i++)d.push({value:v});});return d.sort(()=>Math.random()-0.5);}

function nextRound(){
    if (deck.length === 0 && (players[0].hand.length === 0 || phase === "pick")) return endGame();
    phase="play"; lap=1; turnIndex=0; lastPlayOrder=[]; players.forEach(p=>p.field=[]);
    if(deck.length > 0) { centerCard=deck.pop(); updateInfo(); } else return endGame();
    applyCardDesign(document.getElementById("centerCard"), centerCard.value);
    document.getElementById("centerCard").style.visibility="visible";
    render(); nextTurn();
}

function aiPlay(p){ 
    const d=aiThink(p); 
    if(d.action==="pass") { advanceTurn(); } 
    else { 
        const c=p.hand.splice(d.index,1)[0]; p.field.push(c); 
        lastPlayOrder.push(p.id); 
        if(deck.length) { p.hand.push(deck.pop()); updateInfo(); }
        playSwooshSound(); advanceTurn(); 
    } 
}

function aiThink(p) {
    const mySum = p.field.reduce((a,v)=>a+v.value, 0);
    const others = players.filter(o => o.id !== p.id);
    const maxOther = Math.max(...others.map(o => o.field.reduce((a,v)=>a+v.value, 0)));
    if (lap > 1 && mySum > maxOther && mySum > 0) return {action: "pass"};
    const choices = p.hand.map((c, idx) => ({idx, score: Math.random()}));
    return {action: "play", index: choices[0].idx};
}

function advanceTurn(){ turnIndex++; if(turnIndex>=playerCount){ turnIndex=0; lap++; } render(); nextTurn(); }
function nextTurn(){ if(lap>3) return startPick(); const p=players[getPlayerIdx(turnIndex)]; if(p.id!==0 && phase!=="end") setTimeout(()=>aiPlay(p),800); }
function humanPlay(i){ if(phase!=="play"||getPlayerIdx(turnIndex)!==0)return; const p=players[0]; const c=p.hand.splice(i,1)[0]; p.field.push(c); lastPlayOrder.push(0); if(deck.length){p.hand.push(deck.pop()); updateInfo();} playSwooshSound(); advanceTurn(); }
function pass(){ if(lap===1||phase!=="play"||getPlayerIdx(turnIndex)!==0)return; advanceTurn(); }

function startPick(){
    phase="pick";
    const sums = players.map(p => p.field.reduce((a,c)=>a+c.value,0));
    const maxSum = Math.max(...sums);
    let winners = [];
    sums.forEach((s, idx) => { if(s === maxSum) winners.push(idx); });
    let winner = winners[0];
    if (winners.length > 1) {
        for(let i = lastPlayOrder.length - 1; i >= 0; i--) { if(winners.includes(lastPlayOrder[i])) { winner = lastPlayOrder[i]; break; } }
    }
    const centerEl = document.getElementById("centerCard");
    animateCardSlide(centerEl, `.player-id-${winner} .score-anchor`, centerCard.value, false, () => {
        players[winner].score.push(centerCard); centerEl.style.visibility = "hidden";
        pickIndex = (winner + 1) % playerCount; 
        render(); setTimeout(nextPick, 300);
    });
}

function nextPick() {
    if (!players.some(p => p.field.length)) { startIndex = pickIndex % playerCount; return nextRound(); }
    const p = players[pickIndex];
    let others = players.filter(o => o.id !== p.id && o.field.length);
    let targets = others.length > 0 ? others : [p];
    if (p.id === 0) { render(true, targets.map(t => t.id)); return; }
    executePick(p.id, targets[0].id, 0);
}

function executePick(pickerId, targetId, cardIdx) {
    const picker = players[pickerId]; const target = players[targetId];
    const fromEl = document.querySelector(`.player-id-${targetId} .field .card:nth-child(${cardIdx + 1})`);
    const c = target.field.splice(cardIdx, 1)[0];
    animateCardSlide(fromEl, `.player-id-${pickerId} .score-anchor`, c.value, false, () => {
        picker.score.push(c); pickIndex = (pickIndex + 1) % playerCount; 
        render(); setTimeout(nextPick, 300);
    });
}

function humanPick(targetIdx, cardIdx) { if (phase !== "pick" || pickIndex !== 0) return; executePick(0, targetIdx, cardIdx); }

function endGame(){
    phase = "end";
    players.forEach(p => {
        let groups = {};
        p.score.forEach(c => { if (c.value !== 1) { if (!groups[c.value]) groups[c.value] = []; groups[c.value].push(c); } });
        p.total = 0;
        Object.keys(groups).forEach(val => {
            let cards = groups[val]; let numDead = Math.floor(cards.length / 3) * 3;
            for (let i = 0; i < numDead; i++) cards[i].isDead = true;
        });
        p.score.forEach(c => { if (!c.isDead) p.total += c.value; });
    });
    let maxTotal = Math.max(...players.map(p => p.total));
    let absoluteWinnerId = players.find(p => p.total === maxTotal).id;
    players.forEach(p => p.isAbsoluteWinner = (p.id === absoluteWinnerId));
    render();
}

function backToTitle() { location.reload(); }
function updateInfo() { document.getElementById("infoLabel").innerText = `å±±æœ­æ®‹ã‚Š: ${deck.length}æš`; }
function getPlayerIdx(tIdx) { return (startIndex + tIdx) % playerCount; }
function vClass(v){ return v===-3?"v-3":v===-2?"v-2":v===1?"v1":v===3?"v3":"v4"; }

function applyCardDesign(el, val, isBack=false) {
    if(!el) return; el.style.backgroundImage = ""; el.innerText = "";
    if(isBack) { el.className = "card back"; el.style.backgroundImage = `url('card_back.png')`; } 
    else { el.className = "card " + vClass(val); el.style.backgroundImage = `url('card_${val}.png')`; el.innerText = val; }
}

function animateCardSlide(fromEl, toSelector, value, hideOnEnd, callback) {
    if (!fromEl) return callback();
    const fromRect = fromEl.getBoundingClientRect();
    const toEl = document.querySelector(toSelector);
    const toRect = toEl.getBoundingClientRect();
    const clone = document.createElement('div');
    applyCardDesign(clone, value);
    clone.classList.add('flying-card');
    clone.style.width = fromRect.width + 'px'; clone.style.height = fromRect.height + 'px';
    document.body.appendChild(clone);
    fromEl.style.visibility = "hidden";
    const anim = clone.animate([{ left: fromRect.left + 'px', top: fromRect.top + 'px' },{ left: toRect.left + 'px', top: toRect.top + 'px' }], { duration: 350 });
    anim.onfinish = () => { clone.remove(); callback(); };
}

function render(pick=false,allowedIds=[]){
    const t=document.getElementById("table"); t.querySelectorAll(".player").forEach(e=>e.remove());
    const isEnd = (phase === "end");
    const posConfig = { 3:[{x:600,y:450},{x:20,y:450},{x:20,y:20}], 4:[{x:600,y:450},{x:20,y:450},{x:20,y:20},{x:600,y:20}], 5:[{x:600,y:450},{x:20,y:450},{x:20,y:20},{x:400,y:5},{x:750,y:100}] };
    const positions=posConfig[players.length];
    players.forEach((p,i)=>{
        const d=document.createElement("div"); 
        d.className="player player-id-"+p.id+(p.id===0?" human":"");
        d.style.left=positions[i].x+"px"; d.style.top=positions[i].y+"px";
        if(isEnd && p.isAbsoluteWinner) d.style.outline="5px solid #f1c40f";
        
        let h=`<div style="font-weight:bold;text-align:center;color:#f1c40f;">P${p.id}${p.id===0?"(ã‚ãªãŸ)":""} ${p.trait?`[${p.trait.name}]`:""}</div>`;
        const f=document.createElement("div"); f.className="field";
        p.field.forEach((c,ci)=>{ const cd=document.createElement("div"); applyCardDesign(cd,c.value); if(pick&&allowedIds.includes(p.id)){cd.classList.add("selectable");cd.onclick=()=>humanPick(p.id,ci);} f.appendChild(cd); });
        const hd=document.createElement("div"); hd.className="hand";
        p.hand.forEach((c,idx)=>{ const cd=document.createElement("div"); if(p.id===0&&!isEnd){applyCardDesign(cd,c.value);cd.onclick=()=>humanPlay(idx);} else applyCardDesign(cd,null,true); hd.appendChild(cd); });
        d.innerHTML=h; d.appendChild(f); d.appendChild(hd);
        const scContainer = document.createElement("div"); scContainer.className="score-container";
        const anchor = document.createElement("div"); anchor.className="score-anchor"; anchor.style.cssText = "width:35px;height:52px;border:1px dashed rgba(255,255,255,0.3);";
        p.score.forEach(c => { const scd = document.createElement("div"); applyCardDesign(scd, c.value); scd.style.width="35px"; scd.style.height="52px"; if(isEnd && c.isDead) scd.classList.add("dead"); scContainer.appendChild(scd); });
        scContainer.appendChild(anchor);
        if(isEnd){ 
            const lbl=document.createElement("div"); lbl.innerText=`Score: ${p.total}`; lbl.style.fontWeight="bold"; d.appendChild(lbl);
            if(p.id===0){ const rb=document.createElement("button"); rb.innerText="å†æŒ‘æˆ¦"; rb.onclick=()=>location.reload(); d.appendChild(rb); }
        }
        d.appendChild(scContainer); t.appendChild(d);
    });
}
</script>
</body>
</html>

