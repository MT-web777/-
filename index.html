// --- 修正箇所：nextPick関数内のAI思考ロジックのみをアップデート ---
function nextPick() {
    if (!players.some(p => p.field.length)) { 
        startIndex = (pickIndex) % playerCount; 
        if (deck.length === 0 && players[0].hand.length === 0) return endGame(); 
        return nextRound(); 
    }
    const p = players[pickIndex];
    let others = players.filter(o => o.id !== p.id && o.field.length);
    let targets = others.length > 0 ? others : [p];

    updateUIPanels("獲得パート", `回収中 (P${p.id})`, (p.id === 0) ? "場から1枚取ってください。" : `P${p.id}が獲得中...`);

    if (p.id === 0) { render(true, targets.map(t => t.id)); return; }

    // --- ここからAIの獲得思考（相殺優先） ---
    let bestT = targets[0], bestCi = 0, bestScore = -999999;
    targets.forEach(t => {
        t.field.forEach((c, ci) => {
            let s = 0;
            // 自分がその数字を何枚持っているか確認
            const myOwned = p.score.filter(sc => sc.value === c.value).length;

            // 1. 【最優先】マイナス札の3枚目：相殺（消滅）して0点にするためスコアを跳ね上げる
            if (myOwned === 2 && c.value < 0) {
                s += 1000000; 
            }
            // 2. 1のカード：タイブレークに備えて優先
            else if (c.value === 1) {
                s += 50000;
            }
            // 3. プラス札の3枚目：消滅してしまうので、基本は避ける
            else if (myOwned === 2 && c.value > 1) {
                s -= 50000;
            }
            // 4. マイナス札の2枚目：リーチをかける
            else if (myOwned === 1 && c.value < 0) {
                s += 20000;
            }
            // 5. 通常の加点
            else {
                s += c.value * 1000;
            }

            if (s > bestScore) {
                bestScore = s; bestT = t; bestCi = ci;
            }
        });
    });
    executePick(p.id, bestT.id, bestCi);
}